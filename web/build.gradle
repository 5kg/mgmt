apply plugin: 'java'

version = '1.0'

configurations {
    jruby
}

dependencies {
    jruby 'org.jruby:jruby-complete:1.7.4'
}

ext {
    gemsDir = file(project.projectDir.path + 'vendor/gems')
    bundleDir = file(project.projectDir.path +'vendor/bundle/jruby/1.9/')
}

task installBundler(type: JavaExec) {
    outputs.dir gemsDir
    classpath = configurations.jruby
    main = "org.jruby.Main"
    args "-S gem install --no-rdoc --no-ri bundler -i ${gemsDir}".tokenize()

    doFirst {
        gemsDir.mkdirs()
    }
}

task bundleInstall(type: JavaExec, dependsOn:'installBundler') {
    environment GEM_HOME: gemsDir, GEM_PATH: gemsDir
    classpath = configurations.jruby
    main = "org.jruby.Main"
    args "-S bundle install --path=vendor/bundle --binstubs".tokenize()
}

task runapp(type: JavaExec){
    classpath = project(':cli').jar.outputs.files.plus(configurations.jruby)
    main = "org.jruby.Main"
    args "-S bin/app".tokenize()
}

task jar(type: JavaExec, overwrite: true,dependsOn:'bundleInstall') {
  environment GEM_HOME: gemsDir, GEM_PATH: gemsDir
  classpath = configurations.jruby
  main = "org.jruby.Main"
  args "-S bin/puck --extra-files views/** public/** vendor/jars/**".tokenize()
}

task gemList(type: JavaExec){
    environment GEM_HOME: bundleDir, GEM_PATH: bundleDir
    classpath = project(':cli').jar.outputs.files.plus(configurations.jruby)
    main = "org.jruby.Main"
    args "-S gem list".tokenize()
}

